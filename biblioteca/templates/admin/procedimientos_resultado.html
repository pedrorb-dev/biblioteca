<!-- En templates/admin/procedimientos_resultado.html -->
{% extends "admin/base_site.html" %}
{% load i18n static admin_urls %}

{% block extrastyle %}
{{ block.super }}
<style>
.resultado-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.resultado-header {
    border-bottom: 2px solid #4CAF50;
    padding-bottom: 15px;
    margin-bottom: 20px;
}
.resultado-table {
    width: 100%;
    border-collapse: collapse;
}
.resultado-table th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: bold;
    border-bottom: 2px solid #dee2e6;
}
.resultado-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #dee2e6;
}
.resultado-table tr:hover {
    background-color: #f8f9fa;
}
.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}
.alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}
.action-buttons {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.chart-container {
    height: 400px;
    margin: 20px 0;
}
.libro-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
}
.libro-card h5 {
    color: #333;
    margin-bottom: 10px;
}
.badge-count {
    background: #4CAF50;
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'custom_admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; 
<a href="{% url 'custom_admin:procedimientos' %}">Procedimientos</a>
&rsaquo; Resultados
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="module">
        <div class="resultado-header">
            <h2>{{ title }}</h2>
            <p class="text-muted">{% now "d/m/Y H:i" %}</p>
        </div>
        
        {% if resultado.success %}
            <div class="alert-success">
                <i class="fas fa-check-circle"></i> Procedimiento ejecutado correctamente
            </div>
            
            {% if procedimiento_id == 'reporte_carreras' %}
                <!-- Formulario para filtrar fechas -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <form method="post" action="{% url 'custom_admin:ejecutar_procedimiento' 'reporte_carreras' %}">
                        {% csrf_token %}
                        <h5><i class="fas fa-filter"></i> Filtrar por fecha</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <label>Fecha Inicio:</label>
                                <input type="date" name="fecha_inicio" class="form-control" 
                                       value="{{ request.POST.fecha_inicio|default:'' }}">
                            </div>
                            <div class="col-md-3">
                                <label>Fecha Fin:</label>
                                <input type="date" name="fecha_fin" class="form-control" 
                                       value="{{ request.POST.fecha_fin|default:'' }}">
                            </div>
                            <div class="col-md-3" style="padding-top: 25px;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-sync-alt"></i> Actualizar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Tabla de resultados -->
                <div class="table-responsive">
                    <table class="resultado-table">
                        <thead>
                            <tr>
                                {% for col in columnas %}
                                <th>{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for conjunto in resultado.resultados %}
                                {% for fila in conjunto %}
                                <tr>
                                    <td><strong>{{ fila.carrera_nombre|default:"N/A" }}</strong></td>
                                    <td class="text-center">{{ fila.alumnos_activos|default:"0" }}</td>
                                    <td class="text-center">{{ fila.total_prestamos|default:"0" }}</td>
                                    <td class="text-center">{{ fila.libros_diferentes|default:"0" }}</td>
                                    <td class="text-center">{{ fila.duracion_promedio|default:"0"|floatformat:1 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{{ columnas|length }}" class="text-center">No hay datos disponibles</td>
                                </tr>
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!--
                <div class="chart-container">
                    <canvas id="carrerasChart"></canvas>
                </div>
                -->
                <!-- Datos JSON para el gráfico -->
                {{ resultado.resultados|json_script:"resultados-data" }}
            {% endif %}
            
            {% if procedimiento_id == 'libros_populares' %}
                <form method="post" action="{% url 'custom_admin:ejecutar_procedimiento' 'libros_populares' %}"
                    style="margin-bottom: 20px;">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-3">
                            <label>Mostrar:</label>
                            <select name="limite" class="form-control" id="limiteSelect">
                                <!-- CORREGIDO: Espacios alrededor de == -->
                                <option value="5" {% if selected_limite == "5" %}selected{% endif %}>
                                    5 libros
                                </option>
                
                                <option value="10" {% if selected_limite == "10" or not selected_limite %}selected{% endif %}>
                                    10 libros
                                </option>
                
                                <option value="15" {% if selected_limite == "15" %}selected{% endif %}>
                                    15 libros
                                </option>
                
                                <option value="20" {% if selected_limite == "20" %}selected{% endif %}>
                                    20 libros
                                </option>
                
                                <option value="50" {% if selected_limite == "50" %}selected{% endif %}>
                                    50 libros
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3" style="padding-top: 25px;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                    </div>
                </form>
            
                <!-- Mostrar información del límite actual -->
                <div style="margin-bottom: 15px; color: #666; font-style: italic;">
                    <i class="fas fa-info-circle"></i> Mostrando los {{ selected_limite }} libros más populares
                </div>
                
            
                <!-- Tarjetas de libros -->
                <div class="row">
                        {% for conjunto in resultado.resultados %}
                        {% for libro in conjunto %}
                            <div class="col-md-6 mb-3">
                                <div class="libro-card">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h5>{{ libro.titulo|default:"Sin título" }}</h5>
                                        <span class="badge-count">{{ libro.total_prestamos|default:"0" }} préstamos</span>
                                    </div>
                                    <p><strong>Autor:</strong> {{ libro.autor|default:"Desconocido" }}</p>
                                    <p><strong>Categoría:</strong> {{ libro.categoria|default:"General" }}</p>
                                    <p>
                                        <strong>Estado:</strong> 
                                        <span class="badge {% if libro.status == 'DISPONIBLE' %}bg-success{% else %}bg-warning{% endif %}">
                                            {{ libro.status|default:"DESCONOCIDO" }}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <div class="alert alert-info">
                                    No hay datos de libros disponibles
                                </div>
                            </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
            {% endif %}
            
            <!-- Botones de acción -->
            <div class="action-buttons">
                <a href="{% url 'custom_admin:procedimientos' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver a Procedimientos
                </a>
                <a href="{% url 'custom_admin:index' %}" class="btn btn-outline-primary">
                    <i class="fas fa-home"></i> Ir al Panel Principal
                </a>
            </div>
            
        {% else %}
            <div class="alert-error">
                <i class="fas fa-exclamation-triangle"></i> Error: {{ resultado.error|default:"Error desconocido" }}
            </div>
            
            <div class="action-buttons">
                <a href="{% url 'custom_admin:procedimientos' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver a Procedimientos
                </a>
                <a href="{% url 'custom_admin:index' %}" class="btn btn-outline-primary">
                    <i class="fas fa-home"></i> Ir al Panel Principal
                </a>
            </div>
        {% endif %}
    </div>
</div>

{% if resultado.success and procedimiento_id == 'reporte_carreras' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let resultados = [];
    try {
        const raw = document.getElementById('resultados-data');
        if (raw) {
            resultados = JSON.parse(raw.textContent || '[]');
        }
    } catch (e) {
        console.error('Error parseando resultados JSON:', e);
        return;
    }

    if (!Array.isArray(resultados) || resultados.length === 0) return;
    const datosPrincipal = Array.isArray(resultados[0]) ? resultados[0] : resultados;

    if (!datosPrincipal || datosPrincipal.length === 0) return;

    const carreras = datosPrincipal.map(r => (r && r.carrera_nombre) ? r.carrera_nombre : 'Sin nombre');
    const prestamos = datosPrincipal.map(r => (r && typeof r.total_prestamos !== 'undefined') ? Number(r.total_prestamos) : 0);

    const canvas = document.getElementById('carrerasChart');
    if (!canvas) return;
    
    if (typeof Chart === 'undefined') {
        console.error('Chart.js no está cargado.');
        return;
    }

    try {
        const ctx = canvas.getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: carreras,
                datasets: [{
                    label: 'Total de Préstamos',
                    data: prestamos,
                    backgroundColor: 'rgba(76, 175, 80, 0.7)',
                    borderColor: 'rgba(76, 175, 80, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Número de Préstamos' }
                    },
                    x: {
                        title: { display: true, text: 'Carreras' }
                    }
                }
            }
        });
    } catch (e) {
        console.error('Error creando el chart:', e);
    }
});
</script>
{% endif %}
{% endblock %}